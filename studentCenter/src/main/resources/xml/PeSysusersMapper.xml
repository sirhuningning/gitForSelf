<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.koolearn.crm.system.mapper.PeSysusersMapper">
  <resultMap id="sysuserResultMap" type="com.koolearn.crm.system.model.PeSysusers">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator,do not modify.
      This element was generated on Thu Jan 25 14:05:02 CST 2018.
    -->
    <id column="sysid" property="sysid" jdbcType="INTEGER"/>
    <result column="job_num" property="jobNum" jdbcType="VARCHAR"/>
    <result column="username" property="username" jdbcType="VARCHAR"/>
    <result column="realname" property="realname" jdbcType="VARCHAR"/>
    <result column="phone" property="phone" jdbcType="VARCHAR"/>
    <result column="email" property="email" jdbcType="VARCHAR"/>
    <result column="deptid" property="deptid" jdbcType="INTEGER"/>
    <result column="deptcode" property="deptcode" jdbcType="VARCHAR"/>
    <result column="user_status" property="userStatus" jdbcType="TINYINT"/>
    <result column="user_identity" property="userIdentity" jdbcType="TINYINT"/>
    <result column="calltype" property="calltype" jdbcType="TINYINT"/>
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
    <result column="modify_time" property="modifyTime" jdbcType="TIMESTAMP"/>
    <result column="last_logintime" property="lastLogintime" jdbcType="TIMESTAMP"/>
    <result column="last_loginip" property="lastLoginip" jdbcType="VARCHAR"/>
  </resultMap>

  <insert id="saveSysusers" parameterType="com.koolearn.crm.system.model.PeSysusers">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator,do not modify.
      This element was generated on Thu Jan 25 14:05:02 CST 2018.

    -->
    insert into pe_sysusers (sysid,job_num,username,realname,
      phone,email,deptid,
      deptcode,user_status,calltype,
      create_time,modify_time,last_logintime,
      last_loginip)
    values (#{sysid,jdbcType=INTEGER},#{jobNum,jdbcType=VARCHAR},#{username,jdbcType=VARCHAR},
      #{realname,jdbcType=VARCHAR},#{phone,jdbcType=VARCHAR},#{email,jdbcType=VARCHAR},
      #{deptid,jdbcType=INTEGER},#{deptcode,jdbcType=VARCHAR},#{userStatus,jdbcType=TINYINT},
      #{calltype,jdbcType=TINYINT},#{createTime,jdbcType=TIMESTAMP},#{modifyTime,jdbcType=TIMESTAMP},
      #{lastLogintime,jdbcType=TIMESTAMP},#{lastLoginip,jdbcType=VARCHAR})
  </insert>
  <update id="updateSysusersById" parameterType="com.koolearn.crm.system.model.PeSysusers">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator,do not modify.
      This element was generated on Thu Jan 25 14:05:02 CST 2018.
    -->
    update pe_sysusers
    <trim prefix="set" suffixOverrides=",">
      <if test="realname!=null and realname!=''">
        realname = #{realname,jdbcType=VARCHAR},
      </if>
      <if test="phone!=null and phone!=''">
        phone = #{phone,jdbcType=VARCHAR},
      </if>
      <if test="email!=null and email!=''">
        email = #{email,jdbcType=VARCHAR},
      </if>
      <if test="deptid!=null">
        deptid = #{deptid,jdbcType=INTEGER},
      </if>
      <if test="deptid==null">
        deptid = NULL,
      </if>
      <if test="deptcode!=null and deptcode!=''">
        deptcode = #{deptcode,jdbcType=VARCHAR},
      </if>
      <if test="deptcode==null or deptcode==''">
        deptcode = '',
      </if>
      <if test="userStatus!=null">
        user_status = #{userStatus,jdbcType=TINYINT},
      </if>
      <if test="calltype!=null">
        calltype = #{calltype,jdbcType=TINYINT},
      </if>
      <if test="modifyTime!=null">
        modify_time = #{modifyTime,jdbcType=TIMESTAMP},
      </if>
      <if test="lastLogintime!=null">
        last_logintime = #{lastLogintime,jdbcType=TIMESTAMP},
      </if>
      <if test="lastLoginip!=null and lastLoginip!=''">
        last_loginip = #{lastLoginip,jdbcType=VARCHAR}
      </if>
    </trim>
    where sysid = #{sysid,jdbcType=INTEGER}
  </update>

  <select id="querySysuserByLogin" resultMap="sysuserResultMap" parameterType="java.lang.Integer">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator,do not modify.
      This element was generated on Thu Jan 25 14:05:02 CST 2018.
    -->
    select sysid,username,realname,phone,email,deptid,deptcode,user_status,
    calltype,create_time,modify_time,last_logintime,last_loginip,user_identity
    from pe_sysusers
    where sysid = #{sysid,jdbcType=INTEGER}
  </select>

  <select id="querySysusersById" resultType="java.util.Map" parameterType="java.lang.Integer">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator,do not modify.
      This element was generated on Thu Jan 25 14:05:02 CST 2018.
    -->
    select sysuser.sysid,sysuser.username,sysuser.realname,sysuser.phone,sysuser.email,
    sysuser.deptid,sysuser.deptcode,sysuser.user_status,sysuser.calltype,sysuser.create_time,
    sysuser.modify_time,sysuser.last_logintime,sysuser.last_loginip,sysuser.user_identity,
    role.roleid,role.rolename
    from pe_sysusers sysuser
    left join pr_user_role prole on prole.sysid=sysuser.sysid
    left join pe_role role on role.roleid=prole.roleid
    where sysuser.sysid = #{sysid,jdbcType=INTEGER}
  </select>
  <select id="querySysusersInfo" resultType="java.util.HashMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator,do not modify.
      This element was generated on Thu Jan 25 14:05:02 CST 2018.
    -->
    select s.sysid,s.username,s.realname,r.rolename,s.user_status,s.phone,s.calltype,
    d.deptname,s.email,s.last_logintime,s.last_loginip,s.user_identity
    from pe_sysusers s
    left join pe_department d on s.deptid=d.deptid
    left join pr_user_role ur on ur.sysid=s.sysid
    left join pe_role r on ur.roleid=r.roleid
    <where>
      <if test="uIdentity!=1">
        r.deptcode like '#{deptcode}%'
      </if>
      <if test="username!=null and username!=''">
        and s.username = #{username,jdbcType=VARCHAR}
      </if>
      <if test="realname!=null and realname!=''">
        and s.realname = #{realname,jdbcType=VARCHAR}
      </if>
      <if test="user_status!=null">
        and s.user_status = #{user_status,jdbcType=TINYINT}
      </if>
    </where>
  </select>
  <!--用户登录权限验证-->
  <select id="querySysusersLoginRole" resultType="java.util.HashMap" parameterType="java.lang.Integer">
    select role.roleid,role.roletype,role.rolename,pe_columns.colid,pe_columns.cssname,
    pe_columns.columnname,pe_columns.alias,pe_columns.anothercolname,pe_columns.columnslevel,
    pe_columns.parentid,pe_columns.rank,pe_columns.url,act.actname,act.actcontent,act.actid
    from pe_sysusers s
    join pr_user_role prole on s.sysid=prole.sysid
    join pe_role role on prole.roleid=role.roleid
    join pr_role_column_action role_action on role.roleid=role_action.roleid
    join pr_role_column rcolumn on role_action.roleid=rcolumn.roleid and role_action.colid=rcolumn.colid
    join pe_columns pe_columns on pe_columns.colid=rcolumn.colid
    join pe_action act on act.actid=role_action.actid
    where s.sysid = #{sysid,jdbcType=INTEGER} and pe_columns.isshow=1 and role.rolestatus=1
    order by pe_columns.rank
  </select>
</mapper>